<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<meta content='IE=edge' http-equiv='X-UA-Compatible'>
<meta content='width=device-width, initial-scale=1' name='viewport'>
<!-- / "Website Properties" -->
<meta content='Compose your infrastructure.' name='description'>
<meta content='spox' name='author'>
<link href='img/logo-full-color.png' rel='icon'>
<title>SparkleFormation: Getting Started</title>
<!-- / "CSS resources" -->
<link href="/css/base.css" rel="stylesheet" />
<!-- / "JQuery" -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<!-- / "Favicons" -->
<!-- / Favicons -->
<link href="/img/logo-full-color.png" rel="icon" type="image/png" />
<link href='/img/ico/favicon-144.png' rel='apple-touch-icon-precomposed' sizes='144x144'>
<link href='/img/ico/favicon-114.png' rel='apple-touch-icon-precomposed' sizes='114x114'>
<link href='/img/ico/favicon-72.png' rel='apple-touch-icon-precomposed' sizes='72x72'>
<link href='/img/ico/favicon-57.png' rel='apple-touch-icon-precomposed' sizes='57x57'>

<!-- / "OpenGraph" -->
<!-- / "See http://ogp.me/ for more information" -->
<meta content='http://www.sparkleformation.io/docs/guides/getting-started.html' name='og:url'>
<meta content='website' name='og:type'>
<meta content='SparkleFormation' name='og:site_name'>
<meta content='Getting Started' name='og:title'>
<meta content='Compose your infrastructure.' name='og:description'>
<meta name='og:image'>
<meta name='og:audio'>
<meta name='og:video'>

<!-- / "HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries" -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>

<body>
<div class='navbar'>
<link href="/css/navbar.css" rel="stylesheet" />
<div class='navbar-fixed-top'>
<div class='container'>
<div class='navbar-header'>
<button class='navbar-toggle' data-target='.navbar-collapse' data-toggle='collapse' type='button'>
<span class='fa fa-bars'></span>
</button>
<a class='navbar-brand brand' href='/'>
<img src='/img/logo-full-color.png'>
<span><span class=strong>Sparkle</span><span class=thin>Formation</span></span>
</a>
</div>
<div class='navbar-collapse collapse'>
<ul class='nav navbar-nav navbar-right'>
<li>
<a class='black' href='/#platforms'>
<span>Platforms</span>
</a>
</li>
<li>
<a class='black' href='/docs/'>
<span>Docs</span>
</a>
</li>
</ul>
</div>
</div>
</div>
</div>

<div class='breadcrumbs'>
<link href="/css/breadcrumbs.css" rel="stylesheet" />
<div class='container'>
<div class='row'>
<div class='col-sm-offset-4 col-sm-8 col-md-offset-3 col-md-9'>
<ol class='list-inline'>
<li>
<a href='/docs/'>
<span class='black'>Documentation</span>
</a>
</li>
<li>
<a href='/docs/guides/'>
<span class='black'>Guides</span>
</a>
</li>
<li>
<a href='/docs/guides/getting-started.html'>
<span class='black'>Getting Started</span>
</a>
</li>
</ol>
</div>
</div>
</div>
</div>

<div class='documentation'>
<link href="/css/docs.css" rel="stylesheet" />
<div class='container'>
<div class='row'>
<div class='col-sm-4 col-md-3'>
<div class='sidebar'>
<link href="/css/sidebar.css" rel="stylesheet" />
<ul>
<li>
<a href='/docs/guides/'>Guides</a>
<ul>
<li>
<a href='/docs/guides/getting-started.html'>Getting Started</a>
<ul>
<li>
<a href='/docs/guides/getting-started.html#requirements'>Requirements</a>
</li>
<li>
<a href='/docs/guides/getting-started.html#installation'>Installation</a>
</li>
<li>
<a href='/docs/guides/getting-started.html#configuration'>Configuration</a>
</li>
<li>
<a href='/docs/guides/getting-started.html#setup'>Setup</a>
</li>
<li>
<a href='/docs/guides/getting-started.html#create-a-template'>Create a template</a>
</li>
<li>
<a href='/docs/guides/getting-started.html#create-a-new-stack'>Create a new stack</a>
</li>
<li>
<a href='/docs/guides/getting-started.html#template-refactor'>Template refactor</a>
</li>
<li>
<a href='/docs/guides/getting-started.html#stack-update'>Stack update</a>
</li>
<li>
<a href='/docs/guides/getting-started.html#stack-information'>Stack information</a>
</li>
<li>
<a href='/docs/guides/getting-started.html#clean-up'>Clean up</a>
</li>
</ul>
</li>

<li>
<a href='/docs/guides/apply-and-nested.html'>Stack Dependencies</a>
</li>

<li>
<a href='/docs/guides/tips-and-tricks.html'>Tips and Tricks</a>
</li>

</ul>
</li>

<li>
<a href='/docs/sparkle_formation/'>SparkleFormation</a>
</li>

<li>
<a href='/docs/sfn/'>sfn</a>
</li>


</ul>
</div>

</div>
<div class='col-sm-8 col-md-9'>
<div class='documentation-content'>
<h2 id="requirements">Requirements</h2>&#x000A;&#x000A;<ul>&#x000A;  <li>Ruby (Version <code>&gt;=</code> 2.3)</li>&#x000A;  <li>Provider Credentials</li>&#x000A;</ul>&#x000A;&#x000A;<h3 id="installing-ruby">Installing Ruby</h3>&#x000A;&#x000A;<p>There are a variety of ways to install Ruby depending on platform and toolset. The&#x000A;Ruby website provides information about many of the installation options:</p>&#x000A;&#x000A;<ul>&#x000A;  <li><a href="https://www.ruby-lang.org/en/documentation/installation/">Installing Ruby</a></li>&#x000A;</ul>&#x000A;&#x000A;<h3 id="installing-bundler">Installing Bundler</h3>&#x000A;&#x000A;<p>Once Ruby is installed, install Bundler using the <code>gem</code> command:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ gem install bundler&#x000A;</code></pre></div>&#x000A;<h3 id="provider-credentials">Provider credentials</h3>&#x000A;&#x000A;<p>Required credentials differ based on the target provider in use. For more information&#x000A;about credentials specific to a certain provider, reference the miasma library for&#x000A;the provider:</p>&#x000A;&#x000A;<ul>&#x000A;  <li><a href="https://github.com/miasma-rb/miasma-aws">miasma-aws</a></li>&#x000A;  <li><a href="https://github.com/miasma-rb/miasma-azure">miasma-azure</a></li>&#x000A;  <li><a href="https://github.com/miasma-rb/miasma-google">miasma-google</a></li>&#x000A;  <li><a href="https://github.com/miasma-rb/miasma-open-stack">miasma-open-stack</a></li>&#x000A;  <li><a href="https://github.com/miasma-rb/miasma-rackspace">miasma-rackspace</a></li>&#x000A;  <li><a href="https://github.com/miasma-rb/miasma-terraform">miasma-terraform</a></li>&#x000A;</ul>&#x000A;&#x000A;<h2 id="installation">Installation</h2>&#x000A;&#x000A;<p>First, install the <code>sfn</code> gem:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ gem install sfn&#x000A;</code></pre></div>&#x000A;<p>Now initialize a new project:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ sfn init sparkle-guide&#x000A;</code></pre></div>&#x000A;<p>Finally change to the new project directory:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ cd sparkle-guide&#x000A;</code></pre></div>&#x000A;<h2 id="configuration">Configuration</h2>&#x000A;&#x000A;<p>The <code>init</code> command will have automatically generated a configuration file&#x000A;within the project directory. To view the current configuration status the&#x000A;<code>conf</code> command can be used:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ bundle exec sfn conf&#x000A;</code></pre></div>&#x000A;<p>The configuration file for <code>sfn</code> is located within the <code>.sfn</code> file. Open this file&#x000A;and adjust the credentials section for your desired provider. The generated&#x000A;configuration file uses environment variables for provider configuration. This&#x000A;style of setup makes it easy to automatically set credential information using&#x000A;tools like direnv. Environment variable usage is not required, and credential&#x000A;values can be provided directly.</p>&#x000A;&#x000A;<p><em>NOTE: It is important to <strong>not</strong> store provider credential secrets within the&#x000A;<code>.sfn</code> file if it will be checked into source control.</em></p>&#x000A;&#x000A;<h3 id="test-configuration">Test configuration</h3>&#x000A;&#x000A;<p>Test the configuration by running a list command:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ bundle exec sfn list&#x000A;</code></pre></div>&#x000A;<p>This should print a list of existing stacks on the configured provider. If no&#x000A;stacks exist, no entries will be shown. If an error message is received, check&#x000A;that the credentials information is properly set and try again.</p>&#x000A;&#x000A;<h2 id="create-a-template">Create a template</h2>&#x000A;&#x000A;<p>Lets start by creating a full template. This template will create a compute resource&#x000A;on the desired provider and output the remote public address of the new compute instance.</p>&#x000A;&#x000A;<p>Create a new file: <code>./sparkleformation/compute.rb</code>:</p>&#x000A;&#x000A;<h4 id="template-sparkles-aws">Template sparkles AWS</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:compute</span><span class="p">,</span> <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:aws</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="no">AWSTemplateFormatVersion</span> <span class="s1">'2010-09-09'</span>&#x000A;  <span class="n">description</span> <span class="s1">'Sparkle Guide Compute Template'</span>&#x000A;&#x000A;  <span class="n">parameters</span> <span class="k">do</span>&#x000A;    <span class="n">sparkle_image_id</span><span class="p">.</span><span class="nf">type</span> <span class="s1">'String'</span>&#x000A;    <span class="n">sparkle_ssh_key_name</span><span class="p">.</span><span class="nf">type</span> <span class="s1">'String'</span>&#x000A;    <span class="n">sparkle_flavor</span> <span class="k">do</span>&#x000A;      <span class="n">type</span> <span class="s1">'String'</span>&#x000A;      <span class="n">default</span> <span class="s1">'t2.micro'</span>&#x000A;      <span class="n">allowed_values</span> <span class="p">[</span><span class="s1">'t2.micro'</span><span class="p">,</span> <span class="s1">'t2.small'</span><span class="p">]</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:ec2_instance</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">properties</span> <span class="k">do</span>&#x000A;      <span class="n">image_id</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:sparkle_image_id</span><span class="p">)</span>&#x000A;      <span class="n">instance_type</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:sparkle_flavor</span><span class="p">)</span>&#x000A;      <span class="n">key_name</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:sparkle_ssh_key_name</span><span class="p">)</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">outputs</span><span class="p">.</span><span class="nf">sparkle_public_address</span> <span class="k">do</span>&#x000A;    <span class="n">description</span> <span class="s1">'Compute instance public address'</span>&#x000A;    <span class="n">value</span> <span class="kp">attr</span><span class="o">!</span><span class="p">(</span><span class="ss">:sparkle_ec2_instance</span><span class="p">,</span> <span class="ss">:public_ip</span><span class="p">)</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h4 id="template-sparkles-heat">Template sparkles HEAT</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:compute</span><span class="p">,</span> <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:open_stack</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="n">heat_template_version</span> <span class="s1">'2015-04-30'</span>&#x000A;  <span class="n">description</span> <span class="s1">'Sparkle Guide Compute Template'</span>&#x000A;&#x000A;  <span class="n">parameters</span> <span class="k">do</span>&#x000A;    <span class="n">sparkle_image_id</span><span class="p">.</span><span class="nf">type</span> <span class="s1">'String'</span>&#x000A;    <span class="n">sparkle_ssh_key_name</span><span class="p">.</span><span class="nf">type</span> <span class="s1">'String'</span>&#x000A;    <span class="n">sparkle_flavor</span> <span class="k">do</span>&#x000A;      <span class="n">type</span> <span class="s1">'String'</span>&#x000A;      <span class="n">default</span> <span class="s1">'t2.small'</span>&#x000A;      <span class="n">allowed_values</span> <span class="p">[</span><span class="s1">'m1.small'</span><span class="p">,</span> <span class="s1">'m1.medium'</span><span class="p">]</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:nova_server</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">properties</span> <span class="k">do</span>&#x000A;      <span class="n">image</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:sparkle_image_id</span><span class="p">)</span>&#x000A;      <span class="n">flavor</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:sparkle_flavor</span><span class="p">)</span>&#x000A;      <span class="n">key_name</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:sparkle_ssh_key_name</span><span class="p">)</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">outputs</span><span class="p">.</span><span class="nf">sparkle_public_address</span> <span class="k">do</span>&#x000A;    <span class="n">description</span> <span class="s1">'Compute instance public address'</span>&#x000A;    <span class="n">value</span> <span class="kp">attr</span><span class="o">!</span><span class="p">(</span><span class="ss">:sparkle_nova_instance</span><span class="p">,</span> <span class="s1">'accessIPv4'</span><span class="p">)</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h4 id="template-sparkles-azure">Template sparkles Azure</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:compute</span><span class="p">,</span> <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:azure</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="n">set!</span><span class="p">(</span><span class="s1">'$schema'</span><span class="p">,</span> <span class="s1">'https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#'</span><span class="p">)</span>&#x000A;  <span class="n">content_version</span> <span class="s1">'1.0.0.0'</span>&#x000A;  <span class="n">parameters</span> <span class="k">do</span>&#x000A;    <span class="n">sparkle_image_id</span> <span class="k">do</span>&#x000A;      <span class="n">type</span> <span class="s1">'string'</span>&#x000A;      <span class="n">default_value</span> <span class="s1">'14.04.2-LTS'</span>&#x000A;    <span class="k">end</span>&#x000A;    <span class="n">sparkle_flavor</span> <span class="k">do</span>&#x000A;      <span class="n">type</span> <span class="s1">'string'</span>&#x000A;      <span class="n">allowed_values</span> <span class="p">[</span>&#x000A;        <span class="s1">'Standard_D1'</span>&#x000A;      <span class="p">]</span>&#x000A;    <span class="k">end</span>&#x000A;    <span class="n">storage_account_name</span><span class="p">.</span><span class="nf">type</span> <span class="s1">'string'</span>&#x000A;    <span class="n">storage_container_name</span><span class="p">.</span><span class="nf">type</span> <span class="s1">'string'</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:network_public_ip_addresses</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">properties</span> <span class="k">do</span>&#x000A;      <span class="n">set!</span><span class="p">(</span><span class="s1">'publicIPAllocationMethod'</span><span class="p">,</span> <span class="s1">'Dynamic'</span><span class="p">)</span>&#x000A;      <span class="n">dns_settings</span><span class="p">.</span><span class="nf">domain_name_label</span> <span class="s1">'sparkle'</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:network_virtual_networks</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">properties</span> <span class="k">do</span>&#x000A;      <span class="n">address_space</span><span class="p">.</span><span class="nf">address_prefixes</span> <span class="p">[</span><span class="s1">'10.0.0.0/16'</span><span class="p">]</span>&#x000A;      <span class="n">subnets</span> <span class="n">array!</span><span class="p">(</span>&#x000A;        <span class="o">-&gt;</span><span class="p">{</span>&#x000A;          <span class="nb">name</span> <span class="s1">'sparkle-subnet'</span>&#x000A;          <span class="n">properties</span><span class="p">.</span><span class="nf">address_prefix</span> <span class="s1">'10.0.0.0/24'</span>&#x000A;        <span class="p">}</span>&#x000A;      <span class="p">)</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:network_interfaces</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">properties</span><span class="p">.</span><span class="nf">ip_configurations</span> <span class="n">array!</span><span class="p">(</span>&#x000A;      <span class="o">-&gt;</span><span class="p">{</span>&#x000A;        <span class="nb">name</span> <span class="s1">'ipconfig1'</span>&#x000A;        <span class="n">properties</span> <span class="k">do</span>&#x000A;          <span class="n">set!</span><span class="p">(</span><span class="s1">'privateIPAllocationMethod'</span><span class="p">,</span> <span class="s1">'Dynamic'</span><span class="p">)</span>&#x000A;          <span class="n">set!</span><span class="p">(</span><span class="s1">'publicIPAddress'</span><span class="p">).</span><span class="nf">id</span> <span class="n">resource_id!</span><span class="p">(</span><span class="ss">:sparkle_network_public_ip_addresses</span><span class="p">)</span>&#x000A;          <span class="n">subnet</span><span class="p">.</span><span class="nf">id</span> <span class="n">concat!</span><span class="p">(</span><span class="n">resource_id!</span><span class="p">(</span><span class="ss">:sparkle_network_virtual_networks</span><span class="p">),</span> <span class="s1">'/subnets/sparkle-subnet'</span><span class="p">)</span>&#x000A;        <span class="k">end</span>&#x000A;      <span class="p">}</span>&#x000A;    <span class="p">)</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:compute_virtual_machines</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">properties</span> <span class="k">do</span>&#x000A;      <span class="n">hardware_profile</span><span class="p">.</span><span class="nf">vm_size</span> <span class="n">parameters!</span><span class="p">(</span><span class="ss">:sparkle_flavor</span><span class="p">)</span>&#x000A;      <span class="n">os_profile</span> <span class="k">do</span>&#x000A;        <span class="n">computer_name</span> <span class="s1">'sparkle'</span>&#x000A;        <span class="n">admin_username</span> <span class="s1">'sparkle'</span>&#x000A;        <span class="n">admin_password</span> <span class="s1">'SparkleFormation2016'</span>&#x000A;      <span class="k">end</span>&#x000A;      <span class="n">storage_profile</span> <span class="k">do</span>&#x000A;        <span class="n">image_reference</span> <span class="k">do</span>&#x000A;          <span class="n">publisher</span> <span class="s1">'Canonical'</span>&#x000A;          <span class="n">offer</span> <span class="s1">'UbuntuServer'</span>&#x000A;          <span class="n">sku</span> <span class="n">parameters!</span><span class="p">(</span><span class="ss">:sparkle_image_id</span><span class="p">)</span>&#x000A;          <span class="n">version</span> <span class="s1">'latest'</span>&#x000A;        <span class="k">end</span>&#x000A;        <span class="n">os_disk</span> <span class="k">do</span>&#x000A;          <span class="nb">name</span> <span class="s1">'osdisk'</span>&#x000A;          <span class="n">vhd</span><span class="p">.</span><span class="nf">uri</span> <span class="n">concat!</span><span class="p">(</span><span class="s1">'http://'</span><span class="p">,</span> <span class="n">parameters!</span><span class="p">(</span><span class="ss">:storage_account_name</span><span class="p">),</span> <span class="s1">'.blob.core.windows.net/'</span><span class="p">,</span> <span class="n">parameters!</span><span class="p">(</span><span class="ss">:storage_container_name</span><span class="p">),</span> <span class="s1">'/sparkle.vhd'</span><span class="p">)</span>&#x000A;          <span class="n">caching</span> <span class="s1">'ReadWrite'</span>&#x000A;          <span class="n">create_option</span> <span class="s1">'FromImage'</span>&#x000A;        <span class="k">end</span>&#x000A;        <span class="n">data_disks</span> <span class="n">array!</span><span class="p">(</span>&#x000A;          <span class="o">-&gt;</span><span class="p">{</span>&#x000A;            <span class="nb">name</span> <span class="s1">'datadisk1'</span>&#x000A;            <span class="n">set!</span><span class="p">(</span><span class="s1">'diskSizeGB'</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>&#x000A;            <span class="n">lun</span> <span class="mi">0</span>&#x000A;            <span class="n">vhd</span><span class="p">.</span><span class="nf">uri</span> <span class="n">concat!</span><span class="p">(</span><span class="s1">'http://'</span><span class="p">,</span> <span class="n">parameters!</span><span class="p">(</span><span class="ss">:storage_account_name</span><span class="p">),</span> <span class="s1">'.blob.core.windows.net/'</span><span class="p">,</span> <span class="n">parameters!</span><span class="p">(</span><span class="ss">:storage_container_name</span><span class="p">),</span> <span class="s1">'/sparkle-data.vhd'</span><span class="p">)</span>&#x000A;            <span class="n">create_option</span> <span class="s1">'Empty'</span>&#x000A;          <span class="p">}</span>&#x000A;        <span class="p">)</span>&#x000A;      <span class="k">end</span>&#x000A;      <span class="n">network_profile</span><span class="p">.</span><span class="nf">network_interfaces</span> <span class="n">array!</span><span class="p">(</span>&#x000A;        <span class="o">-&gt;</span><span class="p">{</span> <span class="nb">id</span> <span class="n">resource_id!</span><span class="p">(</span><span class="ss">:sparkle_network_interfaces</span><span class="p">)</span> <span class="p">}</span>&#x000A;      <span class="p">)</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">outputs</span><span class="p">.</span><span class="nf">sparkle_public_address</span> <span class="k">do</span>&#x000A;    <span class="n">type</span> <span class="s1">'string'</span>&#x000A;    <span class="n">value</span> <span class="n">reference!</span><span class="p">(</span><span class="ss">:sparkle_network_public_ip_addresses</span><span class="p">).</span><span class="nf">ipAddress</span>&#x000A;  <span class="k">end</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h3 id="view-template">View template</h3>&#x000A;&#x000A;<p>View the processed JSON result:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ bundle exec sfn print --file compute&#x000A;</code></pre></div>&#x000A;<p>This will output the serialized JSON template generated by SparkleFormation. The JSON is the template&#x000A;content which will be sent to the remote provider API with the stack create request.</p>&#x000A;&#x000A;<h2 id="create-a-new-stack">Create a new stack</h2>&#x000A;&#x000A;<p>After seeing the result of the compiled and serialized template, lets use that template to&#x000A;create a new stack. To start the stack creation process run the following command:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ bundle exec sfn create sparkle-guide-compute --file compute&#x000A;</code></pre></div>&#x000A;<p>Before creating this new stack, <code>sfn</code> will prompt for the parameters defined within the template.&#x000A;The <code>sparkle_image_id</code> and <code>sparkle_ssh_key_name</code> parameters are not defined with default values within the template,&#x000A;so values <em>must</em> be provided when prompted. The prompt for the <code>sparkle_flavor</code> parameter will show the&#x000A;default value defined within the template, and can be used or overridden with a different value.</p>&#x000A;&#x000A;<p>After <code>sfn</code> has completed prompting for stack parameters, it will initiate the stack creation&#x000A;request with the remote provider. The creation request to the API is only for initiation. A successful&#x000A;response does not indicate that the stack was created successfully, rather it indicates that the request&#x000A;to create the stack was successful.</p>&#x000A;&#x000A;<p>Once the create request is complete, <code>sfn</code> will automatically transition to event polling. Resource&#x000A;events related to the new stack will be displayed until the stack reaches a “complete” state: success&#x000A;or failure. The automatic transition to event polling ensures that the <code>sfn create</code> command will return&#x000A;a proper exit code once the stack has reached a completion state.</p>&#x000A;&#x000A;<p>At successful completion of the stack creation, the outputs defined within the template will be displayed&#x000A;showing the public address of the newly created compute instance.</p>&#x000A;&#x000A;<h2 id="template-refactor">Template refactor</h2>&#x000A;&#x000A;<p>A key feature of SparkleFormation is the ability to break down templates into reusable parts which can&#x000A;then be re-used in multiple templates. Lets break down our existing template into re-usable parts and&#x000A;re-build the template using those parts.</p>&#x000A;&#x000A;<h3 id="registry">Registry</h3>&#x000A;&#x000A;<p>The registry is a place to store values that may be used in multiple places. With the value defined in&#x000A;a single location, updates to the value only require one modification to apply globally. In our <code>compute</code>&#x000A;example, the allowed instance flavor values would an ideal candidate for a registry entry.</p>&#x000A;&#x000A;<p>Create a new file at <code>./sparkleformation/registry/instance_flavor.rb</code></p>&#x000A;&#x000A;<h4 id="registry-sparkles-aws">Registry sparkles AWS</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SfnRegistry</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="ss">:instance_flavor</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="p">[</span><span class="s1">'t2.micro'</span><span class="p">,</span> <span class="s1">'t2.small'</span><span class="p">]</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h4 id="registry-sparkles-heat">Registry sparkles HEAT</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SfnRegistry</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="ss">:instance_flavor</span><span class="p">,</span> <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:open_stack</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="p">[</span><span class="s1">'m1.small'</span><span class="p">,</span> <span class="s1">'m1.medium'</span><span class="p">]</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h4 id="registry-sparkles-azure">Registry sparkles Azure</h4>&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SfnRegistry</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="ss">:instance_flavor</span><span class="p">,</span> <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:azure</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="p">[</span><span class="s1">'Standard_D1'</span><span class="p">]</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<p><em>NOTE: For more information see: <a href="/docs/sparkle_formation/building-blocks.html#registry">Registry building blocks</a></em></p>&#x000A;&#x000A;<h3 id="component">Component</h3>&#x000A;&#x000A;<p>Components are items which are used a single time within a template. The version information and description&#x000A;are both items in our <code>compute</code> template that are only used a single time, but should be defined in all templates.&#x000A;Lets move those items into a component.</p>&#x000A;&#x000A;<p>Create a new file at <code>./sparkleformation/components/base.rb</code></p>&#x000A;&#x000A;<h4 id="component-sparkles-aws">Component sparkles AWS</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">component</span><span class="p">(</span><span class="ss">:base</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="no">AWSTemplateFormatVersion</span> <span class="s1">'2010-09-09'</span>&#x000A;  <span class="n">description</span> <span class="s1">'Sparkle Guide Compute Template'</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h4 id="component-sparkles-heat">Component sparkles HEAT</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">component</span><span class="p">(</span><span class="ss">:base</span><span class="p">,</span> <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:open_stack</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="n">heat_template_version</span> <span class="s1">'2015-04-30'</span>&#x000A;  <span class="n">description</span> <span class="s1">'Sparkle Guide Compute Template'</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h4 id="component-sparkles-azure">Component sparkles Azure</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">component</span><span class="p">(</span><span class="ss">:base</span><span class="p">,</span> <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:azure</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="n">set!</span><span class="p">(</span><span class="s1">'$schema'</span><span class="p">,</span> <span class="s1">'https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#'</span><span class="p">)</span>&#x000A;  <span class="n">content_version</span> <span class="s1">'1.0.0.0'</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<p><em>NOTE: For more information see: <a href="/docs/sparkle_formation/building-blocks.html#components">Component building blocks</a></em></p>&#x000A;&#x000A;<h3 id="dynamic">Dynamic</h3>&#x000A;&#x000A;<p>Dynamics are items which can be used multiple times within a template. A dynamic requires a custom name be provided&#x000A;and allows for an optional Hash of values. Dynamics are useful for injecting a common structure into a template&#x000A;multiple times. In the <code>compute</code> template above, we can now extract the remainder of the template and convert it&#x000A;into a dynamic.</p>&#x000A;&#x000A;<p>Create a new file at <code>./sparkleformation/dynamics/node.rb</code></p>&#x000A;&#x000A;<h4 id="dynamic-sparkles-aws">Dynamic sparkles AWS</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">dynamic</span><span class="p">(</span><span class="ss">:node</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="p">{}</span><span class="o">|</span>&#x000A;&#x000A;  <span class="n">parameters</span> <span class="k">do</span>&#x000A;    <span class="n">set!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_image_id"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">).</span><span class="nf">type</span> <span class="s1">'String'</span>&#x000A;    <span class="n">set!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_ssh_key_name"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">).</span><span class="nf">type</span> <span class="s1">'String'</span>&#x000A;    <span class="n">set!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_flavor"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span> <span class="k">do</span>&#x000A;      <span class="n">type</span> <span class="s1">'String'</span>&#x000A;      <span class="n">default</span> <span class="s1">'t2.small'</span>&#x000A;      <span class="n">allowed_values</span> <span class="n">registry!</span><span class="p">(</span><span class="ss">:instance_flavor</span><span class="p">)</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">outputs</span><span class="p">.</span><span class="nf">set!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_public_address"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">description</span> <span class="s2">"Compute instance public address - </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">"</span>&#x000A;    <span class="n">value</span> <span class="kp">attr</span><span class="o">!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_ec2_instance"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">,</span> <span class="ss">:public_ip</span><span class="p">)</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:ec2_instance</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">properties</span> <span class="k">do</span>&#x000A;      <span class="n">image_id</span> <span class="n">ref!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_image_id"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span>&#x000A;      <span class="n">instance_type</span> <span class="n">ref!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_flavor"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span>&#x000A;      <span class="n">key_name</span> <span class="n">ref!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_ssh_key_name"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h4 id="dynamic-sparkles-heat">Dynamic sparkles HEAT</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">dynamic</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:open_stack</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="p">{}</span><span class="o">|</span>&#x000A;&#x000A;  <span class="n">parameters</span> <span class="k">do</span>&#x000A;    <span class="n">set!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_image_id"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">).</span><span class="nf">type</span> <span class="s1">'String'</span>&#x000A;    <span class="n">set!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_ssh_key_name"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">).</span><span class="nf">type</span> <span class="s1">'String'</span>&#x000A;    <span class="n">set!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_flavor"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span> <span class="k">do</span>&#x000A;      <span class="n">type</span> <span class="s1">'String'</span>&#x000A;      <span class="n">default</span> <span class="s1">'t2.small'</span>&#x000A;      <span class="n">allowed_values</span> <span class="n">registry!</span><span class="p">(</span><span class="ss">:instance_flavor</span><span class="p">)</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">outputs</span><span class="p">.</span><span class="nf">set!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_public_address"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">description</span> <span class="s2">"Compute instance public address - </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">"</span>&#x000A;    <span class="n">value</span> <span class="kp">attr</span><span class="o">!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_nova_server"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">,</span> <span class="s1">'accessIPv4'</span><span class="p">)</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:nova_server</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">properties</span> <span class="k">do</span>&#x000A;      <span class="n">image</span> <span class="n">ref!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_image_id"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span>&#x000A;      <span class="n">flavor</span> <span class="n">ref!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_flavor"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span>&#x000A;      <span class="n">key_name</span> <span class="n">ref!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_ssh_key_name"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h4 id="dynamic-sparkles-azure">Dynamic sparkles Azure</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">dynamic</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:azure</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="p">{}</span><span class="o">|</span>&#x000A;  <span class="n">parameters</span> <span class="k">do</span>&#x000A;    <span class="n">set!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_image_id"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span> <span class="k">do</span>&#x000A;      <span class="n">type</span> <span class="s1">'string'</span>&#x000A;      <span class="n">default_value</span> <span class="s1">'14.04.2-LTS'</span>&#x000A;    <span class="k">end</span>&#x000A;    <span class="n">set!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_flavor"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span> <span class="k">do</span>&#x000A;      <span class="n">type</span> <span class="s1">'string'</span>&#x000A;      <span class="n">allowed_values</span> <span class="n">registry!</span><span class="p">(</span><span class="ss">:instance_flavor</span><span class="p">)</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:network_public_ip_addresses</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">properties</span> <span class="k">do</span>&#x000A;      <span class="n">set!</span><span class="p">(</span><span class="s1">'publicIPAllocationMethod'</span><span class="p">,</span> <span class="s1">'Dynamic'</span><span class="p">)</span>&#x000A;      <span class="n">dns_settings</span><span class="p">.</span><span class="nf">domain_name_label</span> <span class="nb">name</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:network_interfaces</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">properties</span><span class="p">.</span><span class="nf">ip_configurations</span> <span class="n">array!</span><span class="p">(</span>&#x000A;      <span class="o">-&gt;</span><span class="p">{</span>&#x000A;        <span class="nb">name</span> <span class="s1">'ipconfig1'</span>&#x000A;        <span class="n">properties</span> <span class="k">do</span>&#x000A;          <span class="n">set!</span><span class="p">(</span><span class="s1">'privateIPAllocationMethod'</span><span class="p">,</span> <span class="s1">'Dynamic'</span><span class="p">)</span>&#x000A;          <span class="n">set!</span><span class="p">(</span><span class="s1">'publicIPAddress'</span><span class="p">).</span><span class="nf">id</span> <span class="n">resource_id!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_network_public_ip_addresses"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span>&#x000A;          <span class="n">subnet</span><span class="p">.</span><span class="nf">id</span> <span class="n">concat!</span><span class="p">(</span><span class="n">resource_id!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_network_virtual_networks"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">),</span> <span class="s1">'/subnets/sparkle-subnet'</span><span class="p">)</span>&#x000A;        <span class="k">end</span>&#x000A;      <span class="p">}</span>&#x000A;    <span class="p">)</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:compute_virtual_machines</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">properties</span> <span class="k">do</span>&#x000A;      <span class="n">hardware_profile</span><span class="p">.</span><span class="nf">vm_size</span> <span class="n">parameters!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_flavor"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span>&#x000A;      <span class="n">os_profile</span> <span class="k">do</span>&#x000A;        <span class="n">computer_name</span> <span class="s1">'sparkle'</span>&#x000A;        <span class="n">admin_username</span> <span class="s1">'sparkle'</span>&#x000A;        <span class="n">admin_password</span> <span class="s1">'SparkleFormation2016'</span>&#x000A;      <span class="k">end</span>&#x000A;      <span class="n">storage_profile</span> <span class="k">do</span>&#x000A;        <span class="n">image_reference</span> <span class="k">do</span>&#x000A;          <span class="n">publisher</span> <span class="s1">'Canonical'</span>&#x000A;          <span class="n">offer</span> <span class="s1">'UbuntuServer'</span>&#x000A;          <span class="n">sku</span> <span class="n">parameters!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_image_id"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span>&#x000A;          <span class="n">version</span> <span class="s1">'latest'</span>&#x000A;        <span class="k">end</span>&#x000A;        <span class="n">os_disk</span> <span class="k">do</span>&#x000A;          <span class="nb">name</span> <span class="s1">'osdisk'</span>&#x000A;          <span class="n">vhd</span><span class="p">.</span><span class="nf">uri</span> <span class="n">concat!</span><span class="p">(</span><span class="s1">'http://'</span><span class="p">,</span> <span class="n">parameters!</span><span class="p">(</span><span class="ss">:storage_account_name</span><span class="p">),</span> <span class="s1">'.blob.core.windows.net/'</span><span class="p">,</span> <span class="n">parameters!</span><span class="p">(</span><span class="ss">:storage_container_name</span><span class="p">),</span> <span class="s2">"/</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">.vhd"</span><span class="p">)</span>&#x000A;          <span class="n">caching</span> <span class="s1">'ReadWrite'</span>&#x000A;          <span class="n">create_option</span> <span class="s1">'FromImage'</span>&#x000A;        <span class="k">end</span>&#x000A;        <span class="n">data_disks</span> <span class="n">array!</span><span class="p">(</span>&#x000A;          <span class="o">-&gt;</span><span class="p">{</span>&#x000A;            <span class="nb">name</span> <span class="s1">'datadisk1'</span>&#x000A;            <span class="n">set!</span><span class="p">(</span><span class="s1">'diskSizeGB'</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>&#x000A;            <span class="n">lun</span> <span class="mi">0</span>&#x000A;            <span class="n">vhd</span><span class="p">.</span><span class="nf">uri</span> <span class="n">concat!</span><span class="p">(</span><span class="s1">'http://'</span><span class="p">,</span> <span class="n">parameters!</span><span class="p">(</span><span class="ss">:storage_account_name</span><span class="p">),</span> <span class="s1">'.blob.core.windows.net/'</span><span class="p">,</span> <span class="n">parameters!</span><span class="p">(</span><span class="ss">:storage_container_name</span><span class="p">),</span> <span class="s2">"/</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">-data.vhd"</span><span class="p">)</span>&#x000A;            <span class="n">create_option</span> <span class="s1">'Empty'</span>&#x000A;          <span class="p">}</span>&#x000A;        <span class="p">)</span>&#x000A;      <span class="k">end</span>&#x000A;      <span class="n">network_profile</span><span class="p">.</span><span class="nf">network_interfaces</span> <span class="n">array!</span><span class="p">(</span>&#x000A;        <span class="o">-&gt;</span><span class="p">{</span> <span class="nb">id</span> <span class="n">resource_id!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_network_interfaces"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span> <span class="p">}</span>&#x000A;      <span class="p">)</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">outputs</span><span class="p">.</span><span class="nf">set!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_public_address"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">type</span> <span class="s1">'string'</span>&#x000A;    <span class="n">value</span> <span class="n">reference!</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_network_public_ip_addresses"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">).</span><span class="nf">ipAddress</span>&#x000A;  <span class="k">end</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<p>The first thing to note about this dynamic file is the <code>name</code> argument at the top.</p>&#x000A;&#x000A;<p><code>SparkleFormation.dynamic(:node) do |name, opts={}|</code></p>&#x000A;&#x000A;<p>This variable is used throughout the dynamic to provide uniquely named parameters, resources, and outputs. Also&#x000A;note the use of they registry to define the allowed values for the flavor parameter.</p>&#x000A;&#x000A;<p><code>allowed_values registry!(:instance_flavor)</code></p>&#x000A;&#x000A;<p><em>NOTE: For more information see: <a href="/docs/sparkle_formation/building-blocks.html#dynamics">Dynamic building blocks</a></em></p>&#x000A;&#x000A;<h3 id="template">Template</h3>&#x000A;&#x000A;<p>Now that the original template has been refactored into re-usable parts, lets update our <code>./sparkleformation/compute.rb</code>&#x000A;template:</p>&#x000A;&#x000A;<h4 id="template-sparkles-aws-1">Template sparkles AWS</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:compute</span><span class="p">,</span> <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:aws</span><span class="p">).</span><span class="nf">load</span><span class="p">(</span><span class="ss">:base</span><span class="p">).</span><span class="nf">overrides</span> <span class="k">do</span>&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h4 id="template-sparkles-heat-1">Template sparkles HEAT</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:compute</span><span class="p">,</span> <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:open_stack</span><span class="p">).</span><span class="nf">load</span><span class="p">(</span><span class="ss">:base</span><span class="p">).</span><span class="nf">overrides</span> <span class="k">do</span>&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h4 id="template-sparkles-azure-1">Template sparkles Azure</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:compute</span><span class="p">,</span> <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:azure</span><span class="p">).</span><span class="nf">load</span><span class="p">(</span><span class="ss">:base</span><span class="p">).</span><span class="nf">overrides</span> <span class="k">do</span>&#x000A;  <span class="n">parameters</span> <span class="k">do</span>&#x000A;    <span class="n">storage_account_name</span><span class="p">.</span><span class="nf">type</span> <span class="s1">'string'</span>&#x000A;    <span class="n">storage_container_name</span><span class="p">.</span><span class="nf">type</span> <span class="s1">'string'</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:network_virtual_networks</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">properties</span> <span class="k">do</span>&#x000A;      <span class="n">address_space</span><span class="p">.</span><span class="nf">address_prefixes</span> <span class="p">[</span><span class="s1">'10.0.0.0/16'</span><span class="p">]</span>&#x000A;      <span class="n">subnets</span> <span class="n">array!</span><span class="p">(</span>&#x000A;        <span class="o">-&gt;</span><span class="p">{</span>&#x000A;          <span class="nb">name</span> <span class="s1">'sparkle-subnet'</span>&#x000A;          <span class="n">properties</span><span class="p">.</span><span class="nf">address_prefix</span> <span class="s1">'10.0.0.0/24'</span>&#x000A;        <span class="p">}</span>&#x000A;      <span class="p">)</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<p>The template is now greatly compacted, and composed entirely of re-usable parts. The <code>.load(:base)</code> is inserting&#x000A;the base component we defined above. The <code>dynamic!(:node, :sparkle)</code> is inserting the node dynamic we defined&#x000A;above and using the custom name <code>sparkle</code>. We can print this template, and see the result is the same as the original&#x000A;template.</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ sfn print --file compute&#x000A;</code></pre></div>&#x000A;<h2 id="stack-update">Stack update</h2>&#x000A;&#x000A;<h3 id="the-no-op-update">The NO-OP update</h3>&#x000A;&#x000A;<p>We can verify that our new template is the same as our original template by updating the running stack and applying&#x000A;our new template:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ sfn update sparkle-guide-compute --file compute --defaults&#x000A;</code></pre></div>&#x000A;<p>The <code>--defaults</code> flag will suppress prompts for stack parameters and use the existing values defined for the running&#x000A;stack. The result of this command will either explicitly state that no updates were performed, or the event stream&#x000A;will show that no resources were modified depending on the provider.</p>&#x000A;&#x000A;<p>At the end of the run it will ask:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>[Sfn]: Apply this stack update? (Y/N):&#x000A;</code></pre></div>&#x000A;<p>You can answer Y.</p>&#x000A;&#x000A;<h3 id="the-real-update-parameters">The real update (parameters)</h3>&#x000A;&#x000A;<p>Now lets update the stack by modifying the paramters of the running stack. We will change the flavor of the instance&#x000A;which will result in the resource being replaced within the stack. Run the update command but do not provide the <code>--defaults</code> flag:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ sfn update sparkle-guide-compute --file compute&#x000A;</code></pre></div>&#x000A;<p>Now <code>sfn</code> will prompt for parameter values. Notice that the default values are the values used when creating the&#x000A;stack. When the <code>sparkle_flavor</code> parameter is prompted, choose a different value from the allowed list. After the&#x000A;update has completed, the outputs displayed of the stack will have changed showing a new public address for the&#x000A;compute instance.</p>&#x000A;&#x000A;<h3 id="the-real-update-template">The real update (template)</h3>&#x000A;&#x000A;<p>Since our template has been refactored and is now composed of re-usable parts, it’s easy to quickly expand our stack.&#x000A;Lets add an additional compute resource to our <code>./sparkleformation/compute.rb</code> template:</p>&#x000A;&#x000A;<h4 id="template-sparkles-aws-2">Template sparkles AWS</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:compute</span><span class="p">,</span> <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:aws</span><span class="p">).</span><span class="nf">load</span><span class="p">(</span><span class="ss">:base</span><span class="p">).</span><span class="nf">overrides</span> <span class="k">do</span>&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span>&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="ss">:unicorn</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h4 id="template-sparkles-heat-2">Template sparkles HEAT</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:compute</span><span class="p">,</span> <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:open_stack</span><span class="p">).</span><span class="nf">load</span><span class="p">(</span><span class="ss">:base</span><span class="p">).</span><span class="nf">overrides</span> <span class="k">do</span>&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span>&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="ss">:unicorn</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h4 id="template-sparkles-azure-2">Template sparkles Azure</h4>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:compute</span><span class="p">,</span> <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:azure</span><span class="p">).</span><span class="nf">load</span><span class="p">(</span><span class="ss">:base</span><span class="p">).</span><span class="nf">overrides</span> <span class="k">do</span>&#x000A;  <span class="n">parameters</span> <span class="k">do</span>&#x000A;    <span class="n">storage_account_name</span><span class="p">.</span><span class="nf">type</span> <span class="s1">'string'</span>&#x000A;    <span class="n">storage_container_name</span><span class="p">.</span><span class="nf">type</span> <span class="s1">'string'</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:network_virtual_networks</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="n">properties</span> <span class="k">do</span>&#x000A;      <span class="n">address_space</span><span class="p">.</span><span class="nf">address_prefixes</span> <span class="p">[</span><span class="s1">'10.0.0.0/16'</span><span class="p">]</span>&#x000A;      <span class="n">subnets</span> <span class="n">array!</span><span class="p">(</span>&#x000A;        <span class="o">-&gt;</span><span class="p">{</span>&#x000A;          <span class="nb">name</span> <span class="s1">'sparkle-subnet'</span>&#x000A;          <span class="n">properties</span><span class="p">.</span><span class="nf">address_prefix</span> <span class="s1">'10.0.0.0/24'</span>&#x000A;        <span class="p">}</span>&#x000A;      <span class="p">)</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span>&#x000A;  <span class="n">dynamic!</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="ss">:unicorn</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<p>Printing the template we can see that by adding a single line we have added not only a new resource to our template,&#x000A;but a new output as well.</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ sfn print --file compute&#x000A;</code></pre></div>&#x000A;<p>Now we can apply this updated template to our existing stack. On this update command, we <em>must</em> provide the <code>--file</code>&#x000A;flag so our modified template will be sent in our request:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ sfn update sparkle-guide-compute --file compute&#x000A;</code></pre></div>&#x000A;<p>When <code>sfn</code> prompts for parameters, the previously seen <code>sparkle</code> parameters will be requested, but we will also&#x000A;see new <code>unicorn</code> parameters requested for the new compute resource we added. After the update has completed the&#x000A;stack outputs will be displayed and will now include two public addresses: one for <code>sparkle</code> and one for <code>unicorn</code>.</p>&#x000A;&#x000A;<h2 id="stack-information">Stack information</h2>&#x000A;&#x000A;<p>With stacks currently existing on the remote provider, we can now use the inspection commands:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ sfn list&#x000A;</code></pre></div>&#x000A;<p>Will provide a list of current stacks. This may include only the <code>sparkle-guide-compute</code> stack or it may include&#x000A;other stacks that were created by other users or the provider itself.</p>&#x000A;&#x000A;<p>We can also describe a specific stack. The describe command will list all the resources composing the requested&#x000A;stack, as well as any stack outputs defined for the stack:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ sfn describe sparkle-guide-compute&#x000A;</code></pre></div>&#x000A;<h2 id="clean-up">Clean up</h2>&#x000A;&#x000A;<p>To conclude this guide, we want to be sure to remove the example stack we created. This is done using the&#x000A;destroy command:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ sfn destroy sparkle-guide-compute&#x000A;</code></pre></div>

</div>
</div>
</div>
</div>
</div>

<div class='footer section theme-bg-inverse'>
<link href="/css/section.css" rel="stylesheet" />
<link href="/css/footer.css" rel="stylesheet" />
<div class='container'>
<div class='row content-row'>
<div class='col-sm-2 col-sm-offset-0 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2'>
<div class='list'>
<div class='row'>
<link href="/css/list.css" rel="stylesheet" />
<div class='col-sm-12 list-column'>
<ul class='list-unstyled'>
<li>
<div class='white'>
<div class='content-block'>
<link href="/css/content-block.css" rel="stylesheet" />

<div class='content-body'>
<span>
<p><a href="/">Home</a></p>


</span>

</div>
</div>

</div>

</li>
<li>
<span>
<p><a href="/#components">Components</a></p>


</span>

</li>
<li>
<span>
<p><a href="/#features">Features</a></p>


</span>

</li>
<li>
<div class='white'>
<div class='content-block'>
<link href="/css/content-block.css" rel="stylesheet" />

<div class='content-body'>
<span>
<p><a href="/docs/">Docs</a></p>


</span>

</div>
</div>

</div>

</li>
<li>
<span>
<p><a href="/docs/guides/getting-started.html">Getting Started</a></p>


</span>

</li>
<li>
<span>
<p><a href="/docs/sparkle_formation/">Library &amp; DSL</a></p>


</span>

</li>
<li>
<span>
<p><a href="/docs/sfn/">CLI</a></p>


</span>

</li>
</ul>
</div>
</div>
</div>

</div>

</div>

<div class='text-center'>
<div class='content-block'>
<link href="/css/content-block.css" rel="stylesheet" />

<div class='content-body'>
<span>
<p><a href="https://twitter.com/sfnftw"><span class="social-icon fa fa-twitter"></span></a> <a href="https://github.com/sparkleformation"><span class="social-icon fa fa-github"></span></a></p>


</span>

<span>
<p>Made with <span class="fa fa-heart"></span> by <a href="https://github.com/chrisroberts">spox</a> © 2013-2019</p>


</span>

</div>
</div>

</div>

</div>
</div>


<tail>
<!-- / "JQuery + Bootstrap" -->
<script src="/js/bootstrap/bootstrap.js"></script>
<!-- / "IE10 viewport hack for Surface/desktop Windows 8 bug" -->
<script src="/js/ie10-viewport-bug-workaround.js"></script>
<!-- / "Google Analytics" -->

<!-- / "Twitter" -->

<!-- / "Auto loader for custom Javascript" -->
<!-- / = javascript_include_tag "all" -->
<script src="/js/sparkleformation.js"></script>
<script src="/js/typetype.min.js"></script>
</tail>

</body>
</html>
