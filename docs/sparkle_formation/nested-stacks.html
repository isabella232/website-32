<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<meta content='IE=edge' http-equiv='X-UA-Compatible'>
<meta content='width=device-width, initial-scale=1' name='viewport'>
<!-- / "Website Properties" -->
<meta content='Compose your infrastructure.' name='description'>
<meta content='spox' name='author'>
<link href='img/logo-full-color.png' rel='icon'>
<title>SparkleFormation: Nested Stacks</title>
<!-- / "CSS resources" -->
<link href="/css/base.css" rel="stylesheet" />
<!-- / "JQuery" -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<!-- / "Favicons" -->
<!-- / Favicons -->
<link href="/img/logo-full-color.png" rel="icon" type="image/png" />
<link href='/img/ico/favicon-144.png' rel='apple-touch-icon-precomposed' sizes='144x144'>
<link href='/img/ico/favicon-114.png' rel='apple-touch-icon-precomposed' sizes='114x114'>
<link href='/img/ico/favicon-72.png' rel='apple-touch-icon-precomposed' sizes='72x72'>
<link href='/img/ico/favicon-57.png' rel='apple-touch-icon-precomposed' sizes='57x57'>

<!-- / "OpenGraph" -->
<!-- / "See http://ogp.me/ for more information" -->
<meta content='http://www.sparkleformation.io/docs/sparkle_formation/nested-stacks.html' name='og:url'>
<meta content='website' name='og:type'>
<meta content='SparkleFormation' name='og:site_name'>
<meta content='Nested Stacks' name='og:title'>
<meta content='Compose your infrastructure.' name='og:description'>
<meta name='og:image'>
<meta name='og:audio'>
<meta name='og:video'>

<!-- / "HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries" -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>

<body>
<div class='navbar'>
<link href="/css/navbar.css" rel="stylesheet" />
<div class='navbar-fixed-top'>
<div class='container'>
<div class='navbar-header'>
<button class='navbar-toggle' data-target='.navbar-collapse' data-toggle='collapse' type='button'>
<span class='fa fa-bars'></span>
</button>
<a class='navbar-brand brand' href='/'>
<img src='/img/logo-full-color.png'>
<span><span class=strong>Sparkle</span><span class=thin>Formation</span></span>
</a>
</div>
<div class='navbar-collapse collapse'>
<ul class='nav navbar-nav navbar-right'>
<li>
<a class='black' href='/#platforms'>
<span>Platforms</span>
</a>
</li>
<li>
<a class='black' href='/docs/'>
<span>Docs</span>
</a>
</li>
</ul>
</div>
</div>
</div>
</div>

<div class='breadcrumbs'>
<link href="/css/breadcrumbs.css" rel="stylesheet" />
<div class='container'>
<div class='row'>
<div class='col-sm-offset-4 col-sm-8 col-md-offset-3 col-md-9'>
<ol class='list-inline'>
<li>
<a href='/docs/'>
<span class='black'>Documentation</span>
</a>
</li>
<li>
<a href='/docs/sparkle_formation/'>
<span class='black'>SparkleFormation</span>
</a>
</li>
<li>
<a href='/docs/sparkle_formation/nested-stacks.html'>
<span class='black'>Nested Stacks</span>
</a>
</li>
</ol>
</div>
</div>
</div>
</div>

<div class='documentation'>
<link href="/css/docs.css" rel="stylesheet" />
<div class='container'>
<div class='row'>
<div class='col-sm-4 col-md-3'>
<div class='sidebar'>
<link href="/css/sidebar.css" rel="stylesheet" />
<ul>
<li>
<a href='/docs/guides/'>Guides</a>
</li>

<li>
<a href='/docs/sparkle_formation/'>SparkleFormation</a>
<ul>
<li>
<a href='/docs/sparkle_formation/overview.html'>Overview</a>
</li>

<li>
<a href='/docs/sparkle_formation/sparkleformation-dsl.html'>SparkleFormation DSL</a>
</li>

<li>
<a href='/docs/sparkle_formation/building-blocks.html'>SparkleFormation Building Blocks</a>
</li>

<li>
<a href='/docs/sparkle_formation/anatomy.html'>Template Anatomy</a>
</li>

<li>
<a href='/docs/sparkle_formation/helper-methods.html'>Helper Methods</a>
</li>

<li>
<a href='/docs/sparkle_formation/nested-stacks.html'>Nested Stacks</a>
<ul>
<li>
<a href='/docs/sparkle_formation/nested-stacks.html#shallow-nesting'>Shallow Nesting</a>
</li>
<li>
<a href='/docs/sparkle_formation/nested-stacks.html#deep-nesting'>Deep Nesting</a>
</li>
</ul>
</li>

<li>
<a href='/docs/sparkle_formation/sparkle-packs.html'>SparklePacks</a>
</li>

<li>
<a href='/docs/sparkle_formation/inheritance-merging.html'>Inheritance and Merging</a>
</li>

<li>
<a href='/docs/sparkle_formation/stack-policies.html'>Stack Policies</a>
</li>

<li>
<a href='/docs/sparkle_formation/provider-restrictions.html'>Provider Restrictions</a>
</li>

<li>
<a href='/docs/sparkle_formation/translation.html'>Translation</a>
</li>

<li>
<a href='/docs/sparkle_formation/compile-time-parameters.html'>Compile Time Parameters</a>
</li>

</ul>
</li>

<li>
<a href='/docs/sfn/'>sfn</a>
</li>


</ul>
</div>

</div>
<div class='col-sm-8 col-md-9'>
<div class='documentation-content'>
<h2 id="nested-stacks">Nested Stacks</h2>&#x000A;&#x000A;<p>Most orchestration API templating systems provide support for a&#x000A;“stack” resource which allows for a stack to define one or more&#x000A;<em>nested</em> stacks within its resources. SparkleFormation expands&#x000A;stack nesting by adding extra functionality when compiling&#x000A;SparkleFormation templates. Currently two styles of expanded&#x000A;functionality are available and are explained in depth below:</p>&#x000A;&#x000A;<ul>&#x000A;  <li><a href="#shallow-nesting">Shallow Nesting</a></li>&#x000A;  <li><a href="#deep-nesting">Deep Nesting</a></li>&#x000A;</ul>&#x000A;&#x000A;<p>The interface for using SparkleFormation’s nested stack functionality&#x000A;is via the <code>nest!</code> helper method. The method accepts a template&#x000A;name and will insert the stack resource into the current template:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:root_template</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="n">nest!</span><span class="p">(</span><span class="ss">:networking</span><span class="p">)</span>&#x000A;  <span class="n">nest!</span><span class="p">(</span><span class="ss">:applications</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h3 id="shallow-nesting">Shallow Nesting</h3>&#x000A;&#x000A;<p>Shallow stack nesting is the original style of nesting functionality&#x000A;implemented within SparkleFormation. Key features/restrictions of&#x000A;shallow nesting:</p>&#x000A;&#x000A;<ul>&#x000A;  <li>Support nesting <em>one</em> level deep</li>&#x000A;  <li>Automatic parameter bubbling to root stack</li>&#x000A;  <li>Automatic output mapping</li>&#x000A;</ul>&#x000A;&#x000A;<h4 id="shallow-nesting-depth">Shallow Nesting Depth</h4>&#x000A;&#x000A;<p>Shallow nesting is restricted to single level nesting. This restriction&#x000A;is in place due to the shallow nesting style being the first successfully&#x000A;implemented nesting strategy. The restriction remains due to the unique&#x000A;behavior this style of nesting provides which does not work well past&#x000A;a single level of nesting.</p>&#x000A;&#x000A;<h4 id="nested-parameter-bubbling">Nested Parameter Bubbling</h4>&#x000A;&#x000A;<p>On compilation SparkleFormation will process nested stacks in a top-down&#x000A;order. It will first extract parameter names from the nested stack. If&#x000A;the root stack has no matching parameter, the parameter will automatically&#x000A;be added to the root stack. For example:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:template_a</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="o">...</span>&#x000A;  <span class="n">parameters</span><span class="p">.</span><span class="nf">fubar</span> <span class="k">do</span>&#x000A;    <span class="n">type</span> <span class="s1">'String'</span>&#x000A;    <span class="n">default</span> <span class="s1">'FOOBAR'</span>&#x000A;  <span class="k">end</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:root</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="n">nest!</span><span class="p">(</span><span class="ss">:template_a</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<p>when compiled would result in:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight json"><code><span class="err">...</span><span class="w">&#x000A;  </span><span class="s2">"Parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;    </span><span class="s2">"Fubar"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;      </span><span class="s2">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">&#x000A;      </span><span class="s2">"Default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FOOBAR"</span><span class="w">&#x000A;    </span><span class="p">}</span><span class="w">&#x000A;  </span><span class="p">},</span><span class="w">&#x000A;  </span><span class="s2">"Resources"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;    </span><span class="s2">"TemplateA"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;      </span><span class="s2">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::CloudFormation::Stack"</span><span class="p">,</span><span class="w">&#x000A;      </span><span class="s2">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;        </span><span class="s2">"Parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;          </span><span class="s2">"Fubar"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;            </span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Fubar"</span><span class="w">&#x000A;          </span><span class="p">}</span><span class="w">&#x000A;&#x000A;</span><span class="err">...</span><span class="w">&#x000A;</span></code></pre></div>&#x000A;<p>If a second stack is nested and it defines a parameter&#x000A;with the same name as a previously defined parameter,&#x000A;only the original parameter will be used and both stacks&#x000A;will reference it.</p>&#x000A;&#x000A;<p>This <em>parameter bubbling</em> behavior allows all contained stacks&#x000A;to be controlled from the root stack providing a single point&#x000A;of interaction.</p>&#x000A;&#x000A;<h4 id="nested-output-mapping">Nested Output Mapping</h4>&#x000A;&#x000A;<p>During compilation and processing of nested stacks, SparkleFormation&#x000A;will also keep list of outputs available from previously processed&#x000A;nested stack resources. If a parameter name on a nested stack&#x000A;matches the name of an output defined in a nested stack, SparkleFormation&#x000A;will automatically update the nested stack resource parameter to&#x000A;use the output value. For example:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:template_a</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="o">...</span>&#x000A;  <span class="n">outputs</span><span class="p">.</span><span class="nf">address</span> <span class="k">do</span>&#x000A;    <span class="n">description</span> <span class="s1">'Address of thing'</span>&#x000A;    <span class="n">value</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:thing</span><span class="p">)</span>&#x000A;  <span class="k">end</span>&#x000A;  <span class="o">...</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:template_b</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="o">...</span>&#x000A;  <span class="n">parameters</span><span class="p">.</span><span class="nf">address</span> <span class="k">do</span>&#x000A;    <span class="n">type</span> <span class="s1">'String'</span>&#x000A;  <span class="k">end</span>&#x000A;  <span class="o">...</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:root_template</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="n">nest!</span><span class="p">(</span><span class="ss">:template_a</span><span class="p">)</span>&#x000A;  <span class="n">nest!</span><span class="p">(</span><span class="ss">:template_b</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<p>When the final template file is compiled SparkleFormation will not&#x000A;bubble the <code>Address</code> parameter to the root stack. Because <code>template_b</code>&#x000A;defines an output with a matching name, SparkleFormation automatically&#x000A;uses that output value:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight json"><code><span class="err">...</span><span class="w">&#x000A;    </span><span class="s2">"TemplateB"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;      </span><span class="s2">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::CloudFormation::Stack"</span><span class="p">,</span><span class="w">&#x000A;      </span><span class="s2">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;        </span><span class="s2">"Parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;          </span><span class="s2">"Address"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;            </span><span class="s2">"Fn:GetAtt"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">&#x000A;              </span><span class="s2">"TemplateA"</span><span class="p">,</span><span class="w">&#x000A;              </span><span class="s2">"Outputs.Address"</span><span class="w">&#x000A;            </span><span class="p">]</span><span class="w">&#x000A;          </span><span class="p">}</span><span class="w">&#x000A;</span><span class="err">...</span><span class="w">&#x000A;</span></code></pre></div>&#x000A;<p>Shallow nesting easily exposes the power of nesting stack resources&#x000A;while maintaining a single point of access for managing a stack. This&#x000A;is important to note when looking at the ease of use for updating&#x000A;running stacks. Unless a template change is required, parameter changes&#x000A;can be made via a single update call to the root stack. It also means&#x000A;that parameter based updates can be provided from any acceptable interface,&#x000A;be it a CLI tool, or web based UI.</p>&#x000A;&#x000A;<p><em>NOTE: One issue quickly encountered with parameter heavy nested stacks&#x000A;is resource limits on the number of parameters allowed within a single&#x000A;stack. Using deep stack nesting prevents this issue.</em></p>&#x000A;&#x000A;<h4 id="shallow-nesting-usage">Shallow Nesting Usage</h4>&#x000A;&#x000A;<p>Shallow nesting is performed by calling <code>SparkleFormation#apply_nesting</code>.&#x000A;The method expects a block to be provided. This block handles storage&#x000A;of the nested stack template (if required) and any updates to the&#x000A;original stack resource.</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="n">sfn</span> <span class="o">=</span> <span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span>&#x000A;&#x000A;<span class="n">sfn</span><span class="p">.</span><span class="nf">apply_nesting</span><span class="p">(</span><span class="ss">:shallow</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">stack_name</span><span class="p">,</span> <span class="n">nested_stack_sfn</span><span class="p">,</span> <span class="n">original_stack_resource</span><span class="o">|</span>&#x000A;  <span class="n">template_content</span> <span class="o">=</span> <span class="n">nested_stack_cfn</span><span class="p">.</span><span class="nf">compile</span><span class="p">.</span><span class="nf">dump!</span>&#x000A;  <span class="c1"># store the template content as required, set remote location as `template_url`</span>&#x000A;  <span class="n">original_stack_resource</span><span class="p">.</span><span class="nf">properites</span><span class="p">.</span><span class="nf">delete!</span><span class="p">(</span><span class="ss">:stack</span><span class="p">)</span>&#x000A;  <span class="n">original_stack_resource</span><span class="p">.</span><span class="nf">properties</span><span class="p">.</span><span class="nf">set!</span><span class="p">(</span><span class="s1">'TemplateURL'</span><span class="p">,</span> <span class="n">template_url</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h3 id="deep-nesting">Deep Nesting</h3>&#x000A;&#x000A;<p>Deep stack nesting is an expansion of the shallow stack nesting functionality.&#x000A;It loses some ease of use but gains greater functionality. Key features/&#x000A;restrictions of deep stack nesting:</p>&#x000A;&#x000A;<ul>&#x000A;  <li>No parameter bubbling</li>&#x000A;  <li>Supports unlimited nesting depths</li>&#x000A;  <li>Automatic output mapping&#x000A;    <ul>&#x000A;      <li>Automatic output bubbling</li>&#x000A;    </ul>&#x000A;  </li>&#x000A;</ul>&#x000A;&#x000A;<h4 id="deep-nested-parameters">Deep Nested Parameters</h4>&#x000A;&#x000A;<p>Deep stack nesting does not provide parameter bubbling. The biggest issue&#x000A;in providing this type of behavior for deeply nested stacks are the limits&#x000A;applied by the API. It also introduces more complexity to the implementation&#x000A;since parameters would have to be propagated from the root stack to the&#x000A;leaf stacks requiring the parameters.</p>&#x000A;&#x000A;<p>Instead of bubbling parameters to the root stack, deep nesting behavior&#x000A;does nothing with the parameters defined for nested stacks. It shifts that&#x000A;responsibility to the application which can update resource’s parameters&#x000A;as it decides using its registered callback handler.</p>&#x000A;&#x000A;<h4 id="unlimited-nesting-depth">Unlimited Nesting Depth</h4>&#x000A;&#x000A;<p>Deep stack nesting does not enforce a limit on the number of levels deep&#x000A;stacks may be nested. This <em>may</em> not be true for the targeted API.&#x000A;Supporting multiple levels of nesting makes it easy to logically&#x000A;compartmentalize related resources into stacks, which can then be&#x000A;collected and compartmentalized into category-style stacks which can be&#x000A;nested into the root stack. This can make it easier to not only develop&#x000A;stacks but easier to reason about as well.</p>&#x000A;&#x000A;<h4 id="automatic-output-mapping-and-bubbling">Automatic Output Mapping and Bubbling</h4>&#x000A;&#x000A;<p>Much like the shallow nesting behavior, deep nesting provides automatic&#x000A;output value mapping to parameters of a matching name. This behavior is&#x000A;more challenging when using deep nesting behavior due to the possibility&#x000A;of outputs being defined in a resource tree that is isolated from a&#x000A;nested stack requiring its value. To solve this problem SparkleFormation&#x000A;will automatically add an output entry to the parent stack(s) “bubbling”&#x000A;the value until the output is available at the same level requesting stack.&#x000A;If the requesting stack is nested from the common depth, then parameters&#x000A;are added to the stacks to “push” the value down.</p>&#x000A;&#x000A;<h5 id="output-bubbling-behavior">Output Bubbling Behavior</h5>&#x000A;&#x000A;<p>This example will illustrate the behavior seen when outputs are “bubbled”:</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:networking</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="o">...</span>&#x000A;  <span class="n">outputs</span><span class="p">.</span><span class="nf">subnet</span> <span class="k">do</span>&#x000A;    <span class="n">description</span> <span class="s1">'Networking subnet'</span>&#x000A;    <span class="n">value</span> <span class="n">ref!</span><span class="p">(</span><span class="ss">:subnet_resource</span><span class="p">)</span>&#x000A;  <span class="k">end</span>&#x000A;  <span class="o">...</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:infrastructure</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="o">...</span>&#x000A;  <span class="n">nest!</span><span class="p">(</span><span class="ss">:networking</span><span class="p">)</span>&#x000A;  <span class="o">...</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:applications</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="o">...</span>&#x000A;  <span class="n">nest!</span><span class="p">(</span><span class="ss">:moneymaker</span><span class="p">)</span>&#x000A;  <span class="o">...</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:moneymaker</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="n">parameters</span><span class="p">.</span><span class="nf">subnet</span> <span class="k">do</span>&#x000A;    <span class="n">type</span> <span class="s1">'String'</span>&#x000A;  <span class="k">end</span>&#x000A;  <span class="o">...</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:root</span><span class="p">)</span> <span class="k">do</span>&#x000A;  <span class="n">nest!</span><span class="p">(</span><span class="ss">:infrastructure</span><span class="p">)</span>&#x000A;  <span class="n">nest!</span><span class="p">(</span><span class="ss">:applications</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<p>When the <code>root</code> stack is compiled, it will first process the <code>infrastructure</code>&#x000A;nesting, which will in turn process the <code>networking</code> nesting. After processing&#x000A;those stacks, SparkleFormation will know the location of the <code>Subnet</code> output.&#x000A;It will then process the <code>application</code> nesting, which has a <code>Subnet</code> parameter&#x000A;matching a known output. Because the <code>Subnet</code> output from <code>networking</code> stack&#x000A;is not accessible from the root stack to provide to the <code>application</code> stack,&#x000A;SparkleFormation will add an output to the <code>infrastructure</code> stack “bubbling”&#x000A;the output to the root stack. Once it is available at the root stack, it can&#x000A;be passed to the <code>application</code> stack resource:</p>&#x000A;&#x000A;<p><em>NOTE: The below example includes the nested stack contents. A real template&#x000A;will simply include a URL endpoint for fetching the document.</em></p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight json"><code><span class="p">{</span><span class="w">&#x000A;  </span><span class="s2">"Resources"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;    </span><span class="s2">"Infrastructure"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;      </span><span class="s2">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::CloudFormation::Stack"</span><span class="p">,</span><span class="w">&#x000A;      </span><span class="s2">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;        </span><span class="s2">"Stack"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;          </span><span class="s2">"Resources"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;            </span><span class="s2">"Networking"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;              </span><span class="s2">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::CloudFormation::Stack"</span><span class="p">,</span><span class="w">&#x000A;              </span><span class="s2">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;                </span><span class="s2">"Stack"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;                  </span><span class="err">...</span><span class="w">&#x000A;                  </span><span class="s2">"Outputs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;                    </span><span class="s2">"Subnet"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;                      </span><span class="s2">"Description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Networking subnet"</span><span class="p">,</span><span class="w">&#x000A;                      </span><span class="s2">"Value"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;                        </span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SubnetResource"</span><span class="w">&#x000A;                      </span><span class="p">}</span><span class="w">&#x000A;                    </span><span class="p">}</span><span class="w">&#x000A;                  </span><span class="p">}</span><span class="w">&#x000A;                </span><span class="p">}</span><span class="w">&#x000A;              </span><span class="p">}</span><span class="w">&#x000A;            </span><span class="p">},</span><span class="w">&#x000A;            </span><span class="s2">"TemplateURL"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://example.com/Networking.json"</span><span class="w">&#x000A;          </span><span class="p">},</span><span class="w">&#x000A;          </span><span class="s2">"Outputs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;            </span><span class="s2">"Subnet"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;              </span><span class="s2">"Value"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;                </span><span class="s2">"Fn::Att"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">&#x000A;                  </span><span class="s2">"Networking"</span><span class="p">,</span><span class="w">&#x000A;                  </span><span class="s2">"Outputs.Subnet"</span><span class="w">&#x000A;                </span><span class="p">]</span><span class="w">&#x000A;              </span><span class="p">}</span><span class="w">&#x000A;            </span><span class="p">}</span><span class="w">&#x000A;          </span><span class="p">}</span><span class="w">&#x000A;        </span><span class="p">},</span><span class="w">&#x000A;        </span><span class="s2">"TemplateURL"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://example.com/Infrastructure.json"</span><span class="w">&#x000A;      </span><span class="p">}</span><span class="w">&#x000A;    </span><span class="p">},</span><span class="w">&#x000A;    </span><span class="s2">"Applications"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;      </span><span class="s2">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::CloudFormation::Stack"</span><span class="p">,</span><span class="w">&#x000A;      </span><span class="s2">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;        </span><span class="s2">"Stack"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;          </span><span class="s2">"Parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;            </span><span class="s2">"Subnet"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;              </span><span class="s2">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="w">&#x000A;            </span><span class="p">}</span><span class="w">&#x000A;          </span><span class="p">},</span><span class="w">&#x000A;          </span><span class="s2">"Resources"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;            </span><span class="s2">"Moneymaker"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;              </span><span class="s2">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::CloudFormation::Stack"</span><span class="p">,</span><span class="w">&#x000A;              </span><span class="s2">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;                </span><span class="s2">"Stack"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;                  </span><span class="s2">"Parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;                    </span><span class="s2">"Subnet"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;                      </span><span class="s2">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="w">&#x000A;                    </span><span class="p">}</span><span class="w">&#x000A;                  </span><span class="p">}</span><span class="w">&#x000A;                  </span><span class="err">...</span><span class="w">&#x000A;                </span><span class="p">},</span><span class="w">&#x000A;                </span><span class="s2">"Parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;                  </span><span class="s2">"Subnet"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;                    </span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Subnet"</span><span class="w">&#x000A;                  </span><span class="p">}</span><span class="w">&#x000A;                </span><span class="p">},</span><span class="w">&#x000A;                </span><span class="s2">"TemplateURL"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://example.com/Moneymaker.json"</span><span class="w">&#x000A;              </span><span class="p">}</span><span class="w">&#x000A;            </span><span class="p">}</span><span class="w">&#x000A;          </span><span class="p">}</span><span class="w">&#x000A;        </span><span class="p">},</span><span class="w">&#x000A;        </span><span class="s2">"Parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;          </span><span class="s2">"Subnet"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">&#x000A;            </span><span class="s2">"Fn::Att"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">&#x000A;              </span><span class="s2">"Infrastructure"</span><span class="p">,</span><span class="w">&#x000A;              </span><span class="s2">"Outputs.Subnet"</span><span class="w">&#x000A;            </span><span class="p">]</span><span class="w">&#x000A;          </span><span class="p">}</span><span class="w">&#x000A;        </span><span class="p">},</span><span class="w">&#x000A;        </span><span class="s2">"TemplateURL"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://example.com/Applications.json"</span><span class="w">&#x000A;      </span><span class="p">}</span><span class="w">&#x000A;    </span><span class="p">}</span><span class="w">&#x000A;  </span><span class="p">}</span><span class="w">&#x000A;</span><span class="p">}</span><span class="w">&#x000A;</span></code></pre></div>&#x000A;<p>When the <code>root</code> template is compiled, it nests the <code>infrastructure</code> template, which in turn&#x000A;nests the <code>networking</code> template. The <code>Subnet</code> output is found, registered, and the compilation&#x000A;continues. At this point the <code>networking</code> template is the last of this “branch”, so compilation&#x000A;returns to the <code>root</code> template and starts on the nested <code>applications</code> template. It has&#x000A;<code>moneymaker</code> nested and when the <code>moneymaker</code> template is processed, the parameter <code>Subnet</code> is&#x000A;checked in the registered outputs. Since a match is found, two things happen:</p>&#x000A;&#x000A;<ol>&#x000A;  <li>The <code>Subnet</code> output is “bubbled” to the <code>infrastructure</code> template</li>&#x000A;  <li>The <code>Subnet</code> output from the <code>infrastructure</code> template is “dripped” into the <code>applications</code>&#x000A;template and passed to the <code>moneymaker</code> template</li>&#x000A;</ol>&#x000A;&#x000A;<p>When a parameter is encountered and a matching output has been registered, SparkleFormation will&#x000A;add stack outputs to parent templates until a common context can be found between the requesting&#x000A;template (template with the parameter) and the providing template (template with the output). The&#x000A;common context for the two templates may not make it accessible to the requesting template, which is&#x000A;where the “dripping” method is employed.</p>&#x000A;&#x000A;<p>Since the requesting template may not have access to the common context (as the example above illustrates),&#x000A;SparkleFormation will “drip” the value down to the template. It does this by injecting a <code>Subnet</code> parameter&#x000A;into child templates and passing the value in the stack resource until it reaches a common depth with&#x000A;the requesting template. Once this is completed, the requesting template will have access to the output&#x000A;from the provider template.</p>&#x000A;&#x000A;<h4 id="deep-nesting-usage">Deep Nesting Usage</h4>&#x000A;&#x000A;<p>Deep nesting is performed by calling <code>SparkleFormation#apply_nesting</code>.&#x000A;The method expects a block to be provided. This block handles storage&#x000A;of the nested stack template (if required) and any updates to the&#x000A;original stack resource.</p>&#x000A;&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="n">sfn</span> <span class="o">=</span> <span class="no">SparkleFormation</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="ss">:sparkle</span><span class="p">)</span>&#x000A;&#x000A;<span class="n">sfn</span><span class="p">.</span><span class="nf">apply_nesting</span><span class="p">(</span><span class="ss">:deep</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">stack_name</span><span class="p">,</span> <span class="n">nested_stack_sfn</span><span class="p">,</span> <span class="n">original_stack_resource</span><span class="o">|</span>&#x000A;  <span class="n">template_content</span> <span class="o">=</span> <span class="n">nested_stack_cfn</span><span class="p">.</span><span class="nf">compile</span><span class="p">.</span><span class="nf">dump!</span>&#x000A;  <span class="c1"># store the template content as required, set remote location as `template_url`</span>&#x000A;  <span class="n">original_stack_resource</span><span class="p">.</span><span class="nf">properites</span><span class="p">.</span><span class="nf">delete!</span><span class="p">(</span><span class="ss">:stack</span><span class="p">)</span>&#x000A;  <span class="n">original_stack_resource</span><span class="p">.</span><span class="nf">properties</span><span class="p">.</span><span class="nf">set!</span><span class="p">(</span><span class="s1">'TemplateURL'</span><span class="p">,</span> <span class="n">template_url</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>

</div>
</div>
</div>
</div>
</div>

<div class='footer section theme-bg-inverse'>
<link href="/css/section.css" rel="stylesheet" />
<link href="/css/footer.css" rel="stylesheet" />
<div class='container'>
<div class='row content-row'>
<div class='col-sm-2 col-sm-offset-0 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2 col-sm-offset-0 col-sm-2'>
<div class='list'>
<div class='row'>
<link href="/css/list.css" rel="stylesheet" />
<div class='col-sm-12 list-column'>
<ul class='list-unstyled'>
<li>
<div class='white'>
<div class='content-block'>
<link href="/css/content-block.css" rel="stylesheet" />

<div class='content-body'>
<span>
<p><a href="/">Home</a></p>


</span>

</div>
</div>

</div>

</li>
<li>
<span>
<p><a href="/#components">Components</a></p>


</span>

</li>
<li>
<span>
<p><a href="/#features">Features</a></p>


</span>

</li>
<li>
<div class='white'>
<div class='content-block'>
<link href="/css/content-block.css" rel="stylesheet" />

<div class='content-body'>
<span>
<p><a href="/docs/">Docs</a></p>


</span>

</div>
</div>

</div>

</li>
<li>
<span>
<p><a href="/docs/guides/getting-started.html">Getting Started</a></p>


</span>

</li>
<li>
<span>
<p><a href="/docs/sparkle_formation/">Library &amp; DSL</a></p>


</span>

</li>
<li>
<span>
<p><a href="/docs/sfn/">CLI</a></p>


</span>

</li>
</ul>
</div>
</div>
</div>

</div>

</div>

<div class='text-center'>
<div class='content-block'>
<link href="/css/content-block.css" rel="stylesheet" />

<div class='content-body'>
<span>
<p><a href="https://twitter.com/sfnftw"><span class="social-icon fa fa-twitter"></span></a> <a href="https://github.com/sparkleformation"><span class="social-icon fa fa-github"></span></a></p>


</span>

<span>
<p>Made with <span class="fa fa-heart"></span> by <a href="https://github.com/chrisroberts">spox</a> © 2013-2019</p>


</span>

</div>
</div>

</div>

</div>
</div>


<tail>
<!-- / "JQuery + Bootstrap" -->
<script src="/js/bootstrap/bootstrap.js"></script>
<!-- / "IE10 viewport hack for Surface/desktop Windows 8 bug" -->
<script src="/js/ie10-viewport-bug-workaround.js"></script>
<!-- / "Google Analytics" -->

<!-- / "Twitter" -->

<!-- / "Auto loader for custom Javascript" -->
<!-- / = javascript_include_tag "all" -->
<script src="/js/sparkleformation.js"></script>
<script src="/js/typetype.min.js"></script>
</tail>

</body>
</html>
